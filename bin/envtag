#!/usr/bin/env bash
# shellcheck shell=bash

usage() {
    cat >&2 <<EOF
usage: ${0##*/} [-0] files...
EOF
    exit 64 # EX_USAGE
}

filter() {
    cat \
        | if [ "${list}" -eq 1 ]; then sed 's/=.*//'; else cat; fi \
        | if [ "${null}" -eq 1 ]; then xe -j0 -N0 printf '%s\0'; else cat; fi
}

list=0
null=0
while getopts :0l arg >/dev/null 2>&1; do
    case "${arg}" in
        0) null=1 ;;
        l) list=1 ;;
        *)
            usage
            ;;
    esac
done
shift $((OPTIND - 1))

for f; do
    ffprobe \
        -loglevel -32 \
        -of json \
        -select_streams a \
        -show_entries stream_tags:format_tags \
        -i "${f}" \
        | jq -r '
            .format.tags
                | with_entries(.key |= ascii_downcase)
                | to_entries[]
                | "\(.key | gsub("[^A-Za-z0-9_]"; "_"))=\(.value | @sh)"
        ' \
        | filter
done
# -e 's/^([^=]+)=(.*)/&; printf "%s: %s\n" "\1" "$\1"/' \
# -e 's/\\n/\n/g                  #lastly we unescape the newlines and nothing else' \
