#!/usr/bin/env bash
#!/usr/bin/env nix-shell
#! nix-shell -i bash -p bash coreutils gnugrep uq
# shellcheck shell=bash

# keep-sorted start skip_lines=1 prefix_order=type,,>,||
type \
    beet-import-phish \
    grep \
    phish-list-shows \
    phishin-like-show \
    tac \
    uq \
    >/dev/null \
    || exit 1
# keep-sorted end

set -euo pipefail

: "${BEET_SYNC_PHISHIN_NOTES:=${HOME}/notes/phish.txt}"

# shellcheck disable=SC2120
usage() {
    # shellcheck disable=SC2059
    [[ "$#" -eq 0 ]] || printf "$@" >&2

    cat >&2 <<EOF
usage: ${0##*/}

Synchronize the metadata of Phish.in shows in the Beets library with
your Phish.in account. This entails:

- importing all shows liked using \`phish-list-shows -l\` and
  \`beet-import-phish\`,
- using \`phishin-like-show\` to like shows whose rating has a rating
  equal to 10, and unlike shows whose rating is less than 10 in the Beets
  database,

Furthermore, it can read a file which is searched for ISO dates, which
are assumed to be shows.

environment variables:
    \$BEET_SYNC_PHISHIN_NOTES${BEET_SYNC_PHISHIN_NOTES:+ (current: ${BEET_SYNC_PHISHIN_NOTES@Q})}
        This file is grepped for ISO-formatted dates, if it exists,
        and the dates it finds are used for building the default list
        of shows to run on.

see also: beet import, phishin-download-show, beet-import-phish,
and the Phish.in project <https://phish.in>.

Kylie McClain <kylie@somas.is>
EOF
    [[ "$#" -eq 0 ]] || exit 1
    exit 64 # EX_USAGE
}

[[ "${1:-}" == --help ]] && usage

shows_to_import=()
notes_mentioned_shows=()
phishin_liked_shows=()

# mapfile -t shows_in_library < <(beet ls -f '$original_year-$original_month-$original_day' -a 'data_source:=Phish.in')

if [[ -e "$BEET_SYNC_PHISHIN_NOTES" ]]; then
    mapfile -t notes_mentioned_shows < <(grep -Eo '[0-9]{4}-[0-9]{2}-[0-9]{2}' "${BEET_SYNC_PHISHIN_NOTES}" | tac)
fi

mapfile -t phishin_liked_shows < <(phish-list-shows -l)

# mapfile -t shows_to_phishin_like < <(
#     {
#         printf '%s\n' "${shows_in_library[@]}"
#         beet ls -f '$original_year-$original_month-$original_day' -a \
#             'data_source:=Phish.in' 'rating:5..10'
#     } | uq
# )

# mapfile -t shows_to_phishin_unlike < <(
#     {
#         beet ls -f '$original_year-$original_month-$original_day' -a \
#             'data_source:=Phish.in' 'rating:0..4'
#     } | uq
# )

mapfile -t shows_to_import < <(printf '%s\n' "${notes_mentioned_shows[@]}" "${phishin_liked_shows[@]}" | uq)
# mapfile -t shows_to_like < <(
#     printf '%s\n' "${shows_in_library[@]}" | uq
# )

beet-import-phish "${shows_to_import[@]}"
