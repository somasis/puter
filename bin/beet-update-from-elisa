#!/usr/bin/env nix-shell
#! nix-shell -i bash -p bash coreutils gnused jq sqlite yq-go
# shellcheck shell=bash

set -euo pipefail

: "${XDG_CONFIG_HOME:=${HOME}/.config}"
: "${XDG_DATA_HOME:=${HOME}/.local/share}"

: "${ELISA_DATABASE:=${XDG_DATA_HOME}/elisa/elisaDatabase.db}"
: "${BEETS_DIRECTORY:=}"

usage() {
    # shellcheck disable=SC2059
    [[ "$#" -eq 0 ]] || printf "$@" >&2

    cat >&2 <<EOF
usage: ${0##*/} [-mMwWy] [beets query]

Update tracks in the Beets database, based off of tracks
stored in the library database for Elisa, the KDE music player.

Currently, this means
- Updating the Beets database entries for tracks which have been rated in
  Elisa's database. Tracks rated in Elisa will have their corresponing
  Beets database entries be updated to have it in their \$rating field.

See also: beet-write-to-elisa

Kylie McClain <kylie@somas.is>
EOF
    exit 64 # EX_USAGE
}

edo() {
    local arg string
    string="$"
    for arg; do
        if [[ "${arg@Q}" == "'$arg'" ]] && ! [[ "${arg}" =~ [[:blank:]] ]]; then
            string+=" $arg"
        else
            string+=" ${arg@Q}"
        fi
    done

    printf '%s\n' "$string" >&2 || :
    "$@"
}

urldecode() {
    # Based off <https://stackoverflow.com/a/37840948>, but modified
    # to get rid of the expectation that spaces are escaped with '+',
    # since this isn't true of Elisa's own URL encoding.
    : "${*}"
    echo -e "${_//%/\\x}"
}

if [[ -z "${BEETS_DIRECTORY}" ]]; then
    # NOTE Special quoting is necessary because yq (v4.47.1 at writing) sloppily
    # tries to access ./.directory if it exists, instead of stdin as expected.
    BEETS_DIRECTORY=$(beet config -d | yq -o json -r '."directory"')

    # shellcheck disable=SC2088
    case "${BEETS_DIRECTORY}" in
        '~/'*) # SC2088: don't suggest using $HOME
            # Expand tildes since `beet config -d` doesn't for us.
            BEETS_DIRECTORY=~/"${BEETS_DIRECTORY#'~/'}"
            ;;
    esac
fi

if ! [[ -e "${ELISA_DATABASE}" ]]; then
    printf 'error: Elisa database file does not exist (expected %s).\n' "${ELISA_DATABASE@Q}" >&2
    printf '       Make sure it exists before running this tool by running Elisa.\n' >&2
    exit 1
fi

# Elisa keeps only absolute, physical (non-symlink) paths in its database.
BEETS_DIRECTORY_absolute=$(readlink -f "${BEETS_DIRECTORY}")

beet_modify_args=()
while getopts :mMwWy arg; do
    case "$arg" in
        [mMwWy]) beet_modify_args+=( -"$arg" ) ;;
        *) usage ;;
    esac
done
shift $(( OPTIND - 1 ))

# Example output:
#     file://
beets=$(
    beet list -f '$rating'$'\t''$path' "$@" \
        | teip -d $'\t' -f 1 -- sed -e 's/^\$rating\t/0\t/' \
        | teip -d $'\t' -f2 -- cut -c $(( ${#BEETS_DIRECTORY} + 2 ))- \
        | sort -s
)

# All paths from Elisa are absolute paths. URL decoding has to be used before
# comparing the paths to the paths in Beets' database. For some reason, jq's
# @urid function is too broad with what it converts, and some characters that
# are not escaped by sqlite (affects some unicode characters; "b√¥a" was a
# testcase string I ran into this issue with), so we need to convert it
# ourselves.
elisa=$(
    sqlite3 -tabs -readonly "${ELISA_DATABASE}" 'SELECT Rating, FileName FROM Tracks;' \
        | teip -d $'\t' -f2 -- xe -LL -j0 -s 'echo -e "${*//%/\\x}"' \
        | teip -d $'\t' -f2 -- sort -snk1 \
        | teip -d $'\t' -f2 -- cut -d' ' -f2- \
        | teip -d $'\t' -f2 -- cut -c $(( 7 + ${#BEETS_DIRECTORY_absolute} + 2 ))- \
        | sort -s
)

# edo diff --color -u <(printf '%s\n' "${beets}") <(printf '%s\n' "${elisa}")
updated_ratings=$(
    comm -13 <(printf '%s\n' "${beets}") <(printf '%s\n' "${elisa}" | grep -v '^0') \
        | teip -d $'\t' -f2 -- xe -LL -j0 printf 'path:%s/%s\n\n' "${BEETS_DIRECTORY}" \
        | teip -d $'\t' -f2 -- sort -snk1 \
        | teip -d $'\t' -f2 -- cut -d' ' -f2-
)
# exit

# Use an associative array to store the ratings.
# This is faster than running `beet modify` per file by orders of magnitude.
modify_args=()
for r in {0..10}; do
    mapfile -t modify_args < <(
        sed -E \
            -e '/^'"${r}"'\t|^,$/!d' \
            -e 's/^[0-9][0-9]*\t//' \
            -e '0~2 a,' \
            <<<"${updated_ratings}"
    )

    [[ "${#modify_args[@]}" -gt 0 ]] || continue

    edo beet modify "${beet_modify_args[@]}" "${modify_args[@]}" rating="${r}"
done
