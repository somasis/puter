#!/usr/bin/env nix-shell
#! nix-shell -i bash -p bash coreutils curl jq
# shellcheck shell=bash

set -euo pipefail

usage() {
    # shellcheck disable=SC2059
    [[ "$#" -eq 0 ]] || printf "$@" >&2

    cat >&2 <<EOF
usage: ${0##*/} <show...>

Like a given show on Phish.in.

options:
    <show>          An ISO formatted date (ex. 1969-12-31)

see also: phishin-auth-login, phishin-list-shows.

Kylie McClain <kylie@somas.is>
EOF
    [[ "$#" -eq 0 ]] || exit 1
    exit 64 # EX_USAGE
}

[[ "$#" -gt 0 ]] || usage 'error: no arguments provided\n'

phishin_auth() {
    local -
    set +x
    : "${PHISHIN_USER_TOKEN:=$(phishin-auth-login)}" || exit 1
    export PHISHIN_USER_TOKEN
}

curl() {
    command curl \
        --no-progress-meter \
        --location \
        --user-agent 'phish-cli <kylie@somas.is>' \
        "$@"
}

curl_authed() {
    # shellcheck disable=SC2016
    [[ -v PHISHIN_USER_TOKEN ]] || usage 'error: no $PHISHIN_USER_TOKEN set\n'

    curl \
        --variable %PHISHIN_USER_TOKEN \
        --expand-header 'X-Auth-Token: {{PHISHIN_USER_TOKEN}}' \
        "${@?curl_authed(): no arguments given}"
}

phishin_auth

errors=0
for show; do
    # /likes requires the show ID be given, not a date
    show_id=$(curl --fail-with-body "https://phish.in/api/v2/shows/${1?no show given}")
    show_id=$(jq -ce '.id' <<<"${show_id}")

    result=$(
        jq -nc --argjson show_id "${show_id}" \
            '{"likable_type": "Show", "likable_id": $show_id}' \
            | curl_authed -X POST --json @- "https://phish.in/api/v2/likes"
    )

    if jq -cre --arg show "$show" '.id' <<<"$result" >/dev/null; then
        printf '%s\n' "$show"
    else
        errors=$((errors + 1))
        printf 'error: failed while liking show %s (id: %i)\n' "$show" "$show_id" >&2
    fi
done

if [[ "$errors" -gt 0 ]]; then
    exit 1
fi
