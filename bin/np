#!/usr/bin/env nix-shell
#! nix-shell -i bash -p bash playerctl kdePackages.qttools.out
# shellcheck shell=bash

player=$(
    playerctl -l | while IFS='' read -r player; do
        case "$(playerctl -p "${player}" status)" in
            "Stopped" | "Paused") : ;;
            *)
                printf '%s\n' "${player}"
                break
                ;;
        esac
    done
)

if [[ -z "$(playerctl -p "${player}" -f '{{album}}' metadata)" ]]; then
    # current playing item has no album tag
    printf 'np: nothing is currently playing\n' >&2
    exit 1
fi

action=$(
    playerctl -p "${player}" -f 'playing {{artist}} - {{title}} (from {{album}})' metadata
)

server="$1"
target="$2"
shift 2

printf '/me is %s\n' "${action}"
