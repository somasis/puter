#!/bin/sh

sed_script=$(
    cat <<'EOF'
    # Color dates (ISO format)
    /^x [0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{4}-[0-9]{2}-[0-9]{2} / { s/^(x [0-9]{4}-[0-9]{2}-[0-9]{2} )([0-9]{4}-[0-9]{2}-[0-9]{2}) /\1[34m\2[39m / }
    /^x \([A-Z]\) [0-9]{4}-[0-9]{2}-[0-9]{2} / { s/([0-9]{4}-[0-9]{2}-[0-9]{2}) /[35m\1[39m / }
    /^x [0-9]{4}-[0-9]{2}-[0-9]{2} / { s/([0-9]{4}-[0-9]{2}-[0-9]{2}) /[35m\1[39m / }

    /^\([A-Z]\) [0-9]{4}-[0-9]{2}-[0-9]{2} / { s/([0-9]{4}-[0-9]{2}-[0-9]{2}) /[34m\1[39m / }
    /^[0-9]{4}-[0-9]{2}-[0-9]{2} / { s/([0-9]{4}-[0-9]{2}-[0-9]{2}) /[34m\1[39m / }

    # Non-specific attributes
    / (\S+:\S+)/ { s/ (\S+:\S+)/ [36m\1[39m/g }

    # Dim UUIDs
    /(uuid:\S+)/ { s/( ?)(uuid:\S+)( ?)/\1[30m\2\3/g }

    /(due:\S+)/ { s/( ?)(due:\S+)( ?)/\1[35m\2\3/g }
    /(t:\S+)/ { s/( ?)(t:\S+)( ?)/\1[35m\2\3/g }

    # @contexts (yellow)
    / (@\S+)/ { s/ (@\S+)/ [33m\1[39m/g }

    # +projects (green)
    / (\+\S+)/ { s/ (\+\S+)/ [32m\1[39m/g }

    /^(\([A]\))/ { s/(\([A]\))/[1;31m\1[0m/g }
    /^(\([B]\))/ { s/(\([B]\))/[1;33m\1[0m/g }
    /^(\([C]\))/ { s/(\([C]\))/[1;32m\1[0m/g }
    /^(\([D]\))/ { s/(\([D]\))/[1;36m\1[0m/g }
    /^(\([E-Z]\))/ { s/(\([E-Z]\))/[1;30m\1[0m/g }

    # Strike out completed tasks
    /^x (.*)/ { s/^x (.*)/[2;9mx \1/ }

    # Reset text coloring
    /$/ { s/$/[0m/ }
EOF
)

[ -n "${NO_COLOR}" ] && exec cat -- "$@"
exec sed -E -e "${sed_script}" -- "$@"
