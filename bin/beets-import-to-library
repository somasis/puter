#!/usr/bin/env nix-shell
#! nix-shell -i bash -p bash coreutils libnotify util-linux yq-go xdg-utils
# shellcheck shell=bash

set -euo pipefail

if [[ -v WITH_NTFY ]]; then
    # Make sure `beet-hook-ntfy-*` doesn't cause duplicated notifications.
    export BEET_HOOK_NTFY_DISABLE=1
fi

# shellcheck disable=SC2120
usage() {
    # shellcheck disable=SC2059
    [[ "$#" -eq 0 ]] || printf "$@" >&2

    cat >&2 <<EOF
usage: ${0##*/} <directory ...>

Import directories into the Beets library, allowing the user to break
out into more manual usage of \`beet import <album>...\` when desired.

environment variables:
    \$WITH_NTFY${WITH_NTFY:+ (current: ${WITH_NTFY@Q})}
    \$NTFY_TOPIC${NTFY_TOPIC:+ (current: ${NTFY_TOPIC@Q})}
        If \$WITH_NTFY is set, send notifications to \$NTFY_TOPIC
        using \`ntfy publish\` on failed and successful imports.

see also: beet import.

Kylie McClain <kylie@somas.is>
EOF

    [[ "$#" -eq 0 ]] || exit 1
    exit 64 # EX_USAGE
}

# shellcheck disable=SC2119
case "${1:---help}" in
    --help | -h) usage ;;
esac

# If another instance is running, just wait until it's gone.
# if [[ "${FLOCKER:-}" != "${0}" ]]; then
#     export FLOCKER="$0"
#     exec flock -e "$0" "$0" "$@"
# fi

edo() {
    local arg string
    string="$"
    for arg; do
        if [[ "${arg@Q}" == "'$arg'" ]] && ! [[ "${arg}" =~ [[:blank:]] ]]; then
            string+=" $arg"
        else
            string+=" ${arg@Q}"
        fi
    done

    printf '%s\n' "$string" >&2 || :
    "$@"
}

notify-send() {
    command notify-send \
        --hint='string:desktop-entry:beets-import-to-library.desktop' \
        "$@"
}

exec-to-terminal() {
    exec xdg-terminal "${*@Q}"
}

finish_import() {
    latest_after_import=$(beet ls -p -a source_path:="${import}" | head -n 1 || :)
    [[ -n "${latest_after_import:-}" ]] \
        && [[ "${latest_after_import}" != "${latest_before_import:-}" ]] \
        || return 1

    # shellcheck disable=SC2016
    if artpath=$(beet ls -f '$artpath' -a source_path:="${import}") && [[ "${artpath}" != 'None' ]]; then
        printf 'using art for notification: %s\n' "${artpath}" >&2
    else
        artpath=
    fi

    # shellcheck disable=SC2016
    format=$(
        beet ls \
            -f 'Successfully imported $albumartist - $album ($year) using metadata from %if{$mb_albumid,<a href=https://musicbrainz.org/release/${mb_albumid}>}$data_source%if{$mb_albumid,</a>}.' \
            -a \
            source_path:="${import}"
    )

    if [[ -n "${WITH_NTFY:-}" ]]; then
        : "${NTFY_TOPIC:?error: no \$NTFY_TOPIC provided}"
        : "${NTFY_CONFIG=${XDG_CONFIG_HOME:=$HOME/.config}/ntfy/client.yml}"
        : "${NTFY_FILE:=${artpath:-}}"

        export NTFY_TOPIC NTFY_CONFIG NTFY_FILE

        export NTFY_TITLE="beets-import-to-library: Imported directory to library"
        export NTFY_MESSAGE="${format}"
        export NTFY_TAGS="${NTFY_TAGS:+$NTFY_TAGS,}cd"
        export NTFY_PRIORITY="${NTFY_PRIORITY:-2}"

        ntfy publish "${NTFY_TOPIC}" &
    fi

    # Fork off here so that the actions are available as long as the
    # notification is.
    {
        action=$(
            notify-send \
                --urgency=normal \
                --replace-id="$id" \
                -a "${0##*/}" \
                -A 'play=Play' \
                -A 'directory=Open directory' \
                -A 'undo=Undo' \
                -A 'redo=Reimport manually...' \
                ${artpath:+-i "${artpath}"} \
                'Music imported to library' \
                "${format}"
        )

        case "${action}" in
            play)
                edo beet play -a source_path:="${import}" &
                ;;
            directory)
                edo xdg-open "${latest_after_import}" &
                disown
                ;;
            undo)
                exec-to-terminal beet rm -adf source_path:="${import}"

                # HACK for beets' thumbnails plugin not deleting .directory :/
                rm -r "${latest_after_import}"
                ;;
            redo)
                exec-to-terminal beet import "${beet_import_args}" \
                    --timid --noincremental \
                    -L source_path:="${import}"
                ;;
        esac
    } &
    disown

    exit
}

beet_import_args=()
for arg in "$@"; do
    case "${arg}" in
        --) break ;;
        --*) beet_import_args+=("${arg}") ;;
        ./* | /* | *) break ;;
    esac
done

beet_config=$(beet config -d)
library_directory=$(<<<"$beet_config" yq '.library')

cover_names=()
mapfile -t cover_names < <(
    yq -r '.fetchart.cover_names[]' <<<"$beet_config" \
        || echo 'cover'
)

for import; do
    if ! [[ -d "$import" ]]; then
        printf 'error: %s is not a directory\n' "${import@Q}" >&2
        exit 64
    fi
done

import_errors=()
for import; do
    error=0

    import=$(readlink -f "${import}")
    export import

    (
        beet_import_args+=(
            --flat # Each argument should count as an album, for the purposes of this script
            --noincremental
            # Used for ensuring we can track this specific album, post-import
            --set=source_path="${import}"
        )

        case "${import}" in
            "${library_directory}"/*)
                beet_import_args+=(--nocopy --move)
                ;;
        esac

        test -e "${import}"

        printf 'importing %s to music library...\n' "${import@Q}" >&2

        # Wait 15 seconds, then begin importing.
        mapfile -t notify_output < <(
            artpath=
            for cover_name in "${cover_names[@]}"; do
                for icon in "$import/$cover_name".*; do
                    [ -e "$icon" ] && artpath="$icon"
                done
            done

            notify-send \
                -t $((15 * 1000)) \
                --urgency=normal \
                --print-id \
                -a "${0##*/}" \
                -A 'timid-exit=Import manually...' \
                -A 'skip=Skip' \
                ${artpath:+"--icon=${artpath}"} \
                'Importing...' \
                "$(basename "${import}")"
        )

        id=${notify_output[0]}

        # shellcheck disable=SC2178
        action=${notify_output[1]:-}

        case "${action}" in
            timid-exit)
                exec-to-terminal \
                    beet import \
                    "${beet_import_args[@]}" \
                    --timid --noincremental \
                    "${import}"
                ;;
            skip) exit 0 ;;
        esac

        latest_before_import=$(beet ls -p -a 'added-' | head -n 1 || :)
        import_exit=0

        beets_skipped_log=$(mktemp)

        edo beet import --quiet \
            --log "$beets_skipped_log" \
            "${beet_import_args[@]}" \
            "${import}"
        import_exit=$?

        if grep -q '^skip' "$beets_skipped_log" || [[ "$import_exit" -ne 0 ]]; then
            import_exit=1

            {
                if [[ -v WITH_NTFY ]]; then
                    : "${NTFY_TOPIC:?error: no \$NTFY_TOPIC provided}"
                    : "${NTFY_CONFIG=${XDG_CONFIG_HOME:=$HOME/.config}/ntfy/client.yml}"
                    : "${NTFY_FILE:=${artpath:-}}"

                    export NTFY_TOPIC NTFY_CONFIG NTFY_FILE

                    export NTFY_TITLE="beets-import-to-library: Failed while importing (error code: ${import_exit})"
                    export NTFY_MESSAGE="${import}"
                    export NTFY_TAGS="${NTFY_TAGS:+$NTFY_TAGS,}speech_balloon"
                    export NTFY_PRIORITY="${NTFY_PRIORITY:-4}"

                    ntfy publish "${NTFY_TOPIC}" &
                fi

                action=$(
                    notify-send --wait \
                        --urgency=critical \
                        --replace-id="$id" \
                        -a "${0##*/}" \
                        -A 'timid-exit=Import manually...' \
                        'Failed to import music' \
                        "Failed to import ${import@Q} (error code: ${import_exit})."
                )

                case "${action}" in
                    timid-exit)
                        exec-to-terminal beet import "${beet_import_args[@]}" \
                            --timid --noincremental \
                            "${import}"
                        ;;
                esac
            } &
            disown

            exit 1
        fi

        rm -f "$beets_skipped_log"

        finish_import
        printf 'successfully imported: %s -> %s\n' "${import@Q}" "${latest_after_import@Q}" >&2
    ) || error=$?

    if [[ "$error" -ne 0 ]]; then
        import_errors+=("$import")
    fi
done

if [[ "${#import_errors[@]}" -gt 0 ]]; then
    printf '\n%i import(s) failed for some reason:\n' "${#import_errors[@]}" >&2
    printf '    - %s\n' "${import_errors[@]}" >&2
    exit 2
fi
