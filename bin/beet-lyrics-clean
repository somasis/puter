#!/usr/bin/env nix-shell
#! nix-shell -i bash -p bash yq-go
# shellcheck shell=bash

set -euo pipefail

# shellcheck disable=SC2120
usage() {
    # shellcheck disable=SC2059
    [[ "$#" -eq 0 ]] || printf "$@" >&2

    cat >&2 <<EOF
usage: ${0##*/} <query>

Automatically clean cruft from lyric fields in the Beets database.

see also: beet-edit-jq, beet-lyrics-unsync

Kylie McClain <kylie@somas.is>
EOF
    [[ "$#" -eq 0 ]] || exit 1
    exit 64 # EX_USAGE
}

case "${1:-}" in
    --help) usage ;;
esac

exec beet-edit-jq -f lyrics "$@" '
    .lyrics |= (
        sub(".*This\\s*song\\s*is\\s*an\\s*instrumental.*|.*[\(\[][Ii]nstrumental[\]\)].*"; "[instrumental]")
        | sub(".*Lyrics for this song have yet to be transcribed.*"; "")
        | sub("^[0-9]+\\s*Contributors?[^\\n]+?(Lyrics|Embed)(.+Read More)?"; "")
    )
'
