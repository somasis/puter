#!/usr/bin/env nix-shell
#! nix-shell -i bash -p bash yq-go
# shellcheck shell=bash

set -euo pipefail

usage() {
    # shellcheck disable=SC2059
    [[ "$#" -eq 0 ]] || printf "$@" >&2

    cat >&2 <<EOF
usage: ${0##*/} <query>

Automatically clean cruft from lyric fields in the Beets database by
acting as an editor driving \`beet edit\`.

see also: beet-lyrics-unsync

Kylie McClain <kylie@somas.is>
EOF
    [[ "$#" -eq 0 ]] || exit 1
    exit 64 # EX_USAGE
}

case "${1:-}" in
    --help) usage ;;
esac

if [[ "${BEET_CLEAN_LYRICS_INSIDE_BEETS_EDIT:=0}" -eq 1 ]]; then
    # NOTE $@ is referring to the YAML file produced by `beet edit`.
    yq --inplace -p yaml -o yaml --expression '
        .lyrics |= (
            sub(".*This\\s*song\\s*is\\s*an\\s*instrumental.*|.*[\(\[][Ii]nstrumental[\]\)].*"; "[instrumental]")
            | sub(".*Lyrics for this song have yet to be transcribed.*"; "")
            | sub("^[0-9]+\\s*Contributors?[^\\n]+?(Lyrics|Embed)(.+Read More)?"; "")
        )
    ' "$@"
    exit $?
fi

export EDITOR="$0"
export BEET_CLEAN_LYRICS_INSIDE_BEETS_EDIT=1

beet -p lyrics \
    edit -f lyrics \
        "$@"
