#!/usr/bin/env bash
#!/usr/bin/env nix-shell
#! nix-shell -i bash -p bash npins

set -euo pipefail

edo() {
    local arg string
    string=
    for arg; do
        if [[ ${arg@Q} == "'$arg'" ]] && ! [[ ${arg} =~ [[:blank:]] ]]; then
            string+="${string:+ }$arg"
        else
            string+="${string:+ }${arg@Q}"
        fi
    done

    printf '$ %s\n' "${string}" >&2
    # alt: printf '$ %s\n' "$(condquote "$@")" >&2

    "$@"
}

for arg; do
    case "$arg" in
        --help) exec npins update "$@" ;;
    esac
done

: "${NPINS_COMMIT_LOCKFILE_SUMMARY:=npins: update}"
: "${NPINS_DIRECTORY:=npins}"

npins_args=()
npins_files=()
while [[ "$#" -gt 0 ]]; do
    case "$1" in
        --directory | -d)
            shift
            NPINS_DIRECTORY="${2:?no directory provided}"
            npins_args+=(--directory "${NPINS_DIRECTORY}")
            ;;
        --lock-file)
            shift
            npins_args+=(--lock-file "${2:?no lock fileprovided}")
            ;;
        *) break ;;
    esac
done

npins_files=("${NPINS_DIRECTORY}/sources.json" "${NPINS_DIRECTORY}/default.nix")

edo npins "${npins_args[@]}" update "$@"
edo git commit -m "${NPINS_COMMIT_LOCKFILE_SUMMARY}" "${npins_files[@]}"
