#!/usr/bin/env nix-shell
#! nix-shell -i bash -p bash yq-go
# shellcheck shell=bash

set -euo pipefail

# shellcheck disable=SC2120
usage() {
    # shellcheck disable=SC2059
    [[ "$#" -eq 0 ]] || printf "$@" >&2

    cat >&2 <<EOF
usage: ${0##*/} <query>

Strip timing from synced/LRC lyrics from tracks matching a Beets query.
Useful for tracks like live recordings, where the lyrics might be very
well be correct, but the timing is likely way off.

see also: beet-lyrics-clean, beet-edit-jq

Kylie McClain <kylie@somas.is>
EOF
    [[ "$#" -eq 0 ]] || exit 1
    exit 64 # EX_USAGE
}

case "${1:-}" in
    --help) usage ;;
esac

# Prepend the query to match for lyrics which contain timing.
exec beet-edit-jq -f lyrics \
    lyrics::'^\[[0-9]+:[0-9]+\.[0-9]+\]' \
    "$@" '
    .lyrics |= (
        split("\n")
            | map(sub("^\\[[0-9]+:[0-9]+\\.[0-9]+\\] ?"; ""))
            | join("\n")
    )
'
